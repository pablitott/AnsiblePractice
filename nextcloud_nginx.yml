---
-
  become: true
  hosts: NextCloudServer
  tasks:
    - name: remove nextcloud packages
      dnf:
        name: epel-release
        state: present

    - name: Install nextcloud packages
      dnf:
        name: yum-utils,epel-release,unzip,curl,wget,bash-completion,policycoreutils-python-utils,mlocate,bzip2,ufw
        state: latest

    - name: Update all packages installed to the latest version available, this task may take several minutes (be patient)
      yum:
        name: "*"
        state: latest

    - name: install php-cfg
      dnf: 
        name: php-fpm
        state: present

    - name: Start php-cfg
      dnf: 
        name: php-fpm
        state: started

    - name: enable php-cfg
      dnf: 
        name: php-fpm
        state: enabled

    - name: install nginx
      dnf: 
        name: nginx
        state: latest

    - name: start  nginx
      service:
        name: nginx
        state: started

    - name: enable nginx
      service:
        name: nginx
        enabled: yes

    - name: Deny as a default status ufw
      ufw:
        default: deny

    - name: enable ufw
      ufw:
        state: enabled
        policy: allow

    - name: Configure open ports with ufw.
      ufw:
        rule: "{{ item.rule }}"
        port: "{{ item.port }}"
        proto: "{{ item.proto }}"
      with_items:
        - { rule: 'allow', port: 22, proto: 'tcp' }
        - { rule: 'allow', port: 80, proto: 'tcp' }
        - { rule: 'allow', port: 443, proto: 'tcp' }

    - name: Configure default incoming/outgoing rules with ufw.
      ufw:
        direction: "{{ item.direction }}"
        policy: "{{ item.policy }}"
        state: enabled
      with_items:
        - { direction: outgoing, policy: allow }
        - { direction: incoming, policy: deny }


